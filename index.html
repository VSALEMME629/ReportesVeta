
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Portal Interno Vetacap</title>
  <link href="https://fonts.googleapis.com/css2?family=Albert+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Mantener los mismos estilos que ya tienes -->
  <style>
    /* Tus estilos actuales */
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <!-- Mantener el mismo HTML que ya tienes -->

  <script>
    // Configuración de GitHub
    const GITHUB_CONFIG = {
      token: '', // Deberás configurar esto en la interfaz de usuario
      owner: '', // Deberás configurar esto en la interfaz de usuario
      repo: '',  // Deberás configurar esto en la interfaz de usuario
      path: 'data/reportes.json'
    };
    
    // Datos de usuarios (mantener estos localmente por seguridad)
    const usuarios = [
      { id: 1, username: "admin", nombre: "Administrador", password: "admin2024", rol: "admin", ultimoAcceso: "15/05/2023" },
      { id: 2, username: "comercial", nombre: "Equipo Comercial", password: "vetacap2024", rol: "comercial", ultimoAcceso: "10/05/2023" }
    ];
    
    // Variables globales
    let reportes = {};
    let usuarioActual = null;
    let editMode = {
      estrategia: false,
      institucional: false
    };
    let githubFileSha = null; // Para guardar el SHA del archivo en GitHub
    
    // Función para cargar datos desde GitHub
    async function cargarDatosDesdeGitHub() {
      if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.owner || !GITHUB_CONFIG.repo) {
        console.log('Configuración de GitHub incompleta');
        cargarDatosLocales();
        return;
      }
      
      try {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
        const response = await fetch(url, {
          headers: {
            'Authorization': `token ${GITHUB_CONFIG.token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          githubFileSha = data.sha; // Guardar el SHA para futuras actualizaciones
          
          // Decodificar el contenido en base64
          const content = atob(data.content);
          reportes = JSON.parse(content);
          
          // Actualizar la interfaz si el usuario está logueado
          if (usuarioActual) {
            cargarReportes("estrategia");
            cargarReportes("institucional");
          }
          
          console.log('Datos cargados desde GitHub');
        } else if (response.status === 404) {
          console.log('El archivo no existe en GitHub, se creará uno nuevo');
          inicializarDatosPorDefecto();
          await guardarDatosEnGitHub();
        } else {
          console.error('Error al cargar datos desde GitHub:', response.statusText);
          cargarDatosLocales();
        }
      } catch (error) {
        console.error('Error al cargar datos desde GitHub:', error);
        cargarDatosLocales();
      }
    }
    
    // Función para guardar datos en GitHub
    async function guardarDatosEnGitHub() {
      if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.owner || !GITHUB_CONFIG.repo) {
        console.log('Configuración de GitHub incompleta');
        localStorage.setItem("vetacap_reportes", JSON.stringify(reportes));
        return false;
      }
      
      try {
        const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.path}`;
        
        // Convertir los datos a base64
        const content = btoa(JSON.stringify(reportes, null, 2));
        
        const body = {
          message: 'Actualización de reportes desde el portal',
          content: content
        };
        
        // Si tenemos el SHA, lo incluimos para actualizar el archivo existente
        if (githubFileSha) {
          body.sha = githubFileSha;
        }
        
        const response = await fetch(url, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${GITHUB_CONFIG.token}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify(body)
        });
        
        if (response.ok) {
          const data = await response.json();
          githubFileSha = data.content.sha; // Actualizar el SHA para futuras operaciones
          console.log('Datos guardados en GitHub');
          return true;
        } else {
          console.error('Error al guardar en GitHub:', response.statusText);
          localStorage.setItem("vetacap_reportes", JSON.stringify(reportes));
          return false;
        }
      } catch (error) {
        console.error('Error al guardar en GitHub:', error);
        localStorage.setItem("vetacap_reportes", JSON.stringify(reportes));
        return false;
      }
    }
    
    // Función para cargar datos desde localStorage (fallback)
    function cargarDatosLocales() {
      const reportesGuardados = localStorage.getItem("vetacap_reportes");
      if (reportesGuardados) {
        reportes = JSON.parse(reportesGuardados);
        console.log('Datos cargados desde localStorage');
      } else {
        inicializarDatosPorDefecto();
      }
      
      // Actualizar la interfaz si el usuario está logueado
      if (usuarioActual) {
        cargarReportes("estrategia");
        cargarReportes("institucional");
      }
    }
    
    // Función para inicializar datos por defecto
    function inicializarDatosPorDefecto() {
      reportes = {
        "reporte-comercial": {
          id: "reporte-comercial",
          seccion: "estrategia",
          titulo: "Reporte Comercial",
          descripcion: "Análisis detallado de ventas, clientes y oportunidades de negocio para optimizar la estrategia comercial.",
          fecha: "15/05/2023",
          url: "https://drive.google.com/file/d/1eNSEh-LZUUbjRhNwmrT_-sR7lswAk2og/view?usp=sharing",
          textoBoton: "Ver reporte"
        },
        "gestion-liquidez": {
          id: "gestion-liquidez",
          seccion: "estrategia",
          titulo: "Gestión de Liquidez",
          descripcion: "Análisis de flujos de efectivo y posiciones de liquidez para optimizar la gestión financiera.",
          fecha: "10/05/2023",
          url: "https://drive.google.com/file/d/1Z2wWJ4p9h6aY7Pp6Iv0UDdo04nRD0o6i/view?usp=sharing",
          textoBoton: "Ver reporte"
        },
        "cobertura-cambiaria": {
          id: "cobertura-cambiaria",
          seccion: "estrategia",
          titulo: "Cobertura Cambiaria",
          descripcion: "Estrategias de cobertura y análisis de riesgo cambiario para proteger las operaciones de la volatilidad.",
          fecha: "05/05/2023",
          url: "https://drive.google.com/file/d/1QcFUyBWdX5E9sWFbxuW4qufIFGGm_eDy/view?usp=sharing",
          textoBoton: "Ver reporte"
        },
        "presentacion-institucional": {
          id: "presentacion-institucional",
          seccion: "institucional",
          titulo: "Presentación Institucional",
          descripcion: "Presentación corporativa de Vetacap para clientes y socios estratégicos.",
          fecha: "20/04/2023",
          url: "#",
          textoBoton: "Descargar PPT"
        },
        "datos-cuenta": {
          id: "datos-cuenta",
          seccion: "institucional",
          titulo: "Datos de Cuenta de Fondeo",
          descripcion: "Información de cuentas bancarias para operaciones de fondeo y transferencias.",
          fecha: "15/04/2023",
          url: "#",
          textoBoton: "Consultar datos"
        },
        "formularios-apertura": {
          id: "formularios-apertura",
          seccion: "institucional",
          titulo: "Formularios de Apertura",
          descripcion: "Documentos necesarios para la apertura de cuentas de clientes.",
          fecha: "10/04/2023",
          url: "#",
          textoBoton: "Descargar formularios"
        }
      };
      console.log('Datos inicializados por defecto');
    }
    
    // Función para inicializar la aplicación
    async function inicializar() {
      // Comprobar si hay una sesión guardada
      const logeado = localStorage.getItem("vetacap_logeado");
      if (logeado === "true") {
        const usuarioGuardado = localStorage.getItem("vetacap_usuario");
        if (usuarioGuardado) {
          usuarioActual = JSON.parse(usuarioGuardado);
          mostrarContenido();
        }
      }
      
      // Cargar configuración de GitHub desde localStorage
      const githubConfig = localStorage.getItem("vetacap_github_config");
      if (githubConfig) {
        Object.assign(GITHUB_CONFIG, JSON.parse(githubConfig));
      }
      
      // Cargar datos desde GitHub o localStorage
      await cargarDatosDesdeGitHub();
    }
    
    // Función para configurar GitHub
    function configurarGitHub() {
      const token = prompt("Ingresa tu token de acceso personal de GitHub:", GITHUB_CONFIG.token);
      const owner = prompt("Ingresa el nombre de usuario o organización del repositorio:", GITHUB_CONFIG.owner);
      const repo = prompt("Ingresa el nombre del repositorio:", GITHUB_CONFIG.repo);
      
      if (token && owner && repo) {
        GITHUB_CONFIG.token = token;
        GITHUB_CONFIG.owner = owner;
        GITHUB_CONFIG.repo = repo;
        
        // Guardar configuración en localStorage
        localStorage.setItem("vetacap_github_config", JSON.stringify(GITHUB_CONFIG));
        
        // Intentar cargar datos desde GitHub
        cargarDatosDesdeGitHub().then(() => {
          mostrarNotificacion("Configuración de GitHub guardada correctamente");
        });
      } else {
        mostrarNotificacion("Configuración incompleta. Se usará almacenamiento local.", "error");
      }
    }
    
    // Modificar las funciones que guardan datos para usar GitHub
    
    function guardarReporte() {
      const id = document.getElementById("reporte-id").value;
      const reporte = reportes[id];
      
      if (!reporte) return;
      
      reporte.titulo = document.getElementById("reporte-titulo").value;
      reporte.descripcion = document.getElementById("reporte-descripcion").value;
      reporte.fecha = document.getElementById("reporte-fecha").value;
      reporte.url = document.getElementById("reporte-url").value;
      reporte.textoBoton = document.getElementById("reporte-boton").value;
      
      // Actualizar la vista
      cargarReportes(reporte.seccion);
      
      // Guardar en GitHub
      guardarDatosEnGitHub().then(exito => {
        // Cerrar modal y mostrar notificación
        cerrarModal("modal-editar-reporte");
        mostrarNotificacion(exito ? 
          "Reporte actualizado correctamente" : 
          "Reporte guardado localmente (error de conexión con GitHub)"
        );
        
        // Resaltar el reporte actualizado
        setTimeout(() => {
          const reporteElement = document.querySelector(`[data-id="${id}"]`);
          if (reporteElement) {
            reporteElement.classList.add("update-highlight");
            setTimeout(() => {
              reporteElement.classList.remove("update-highlight");
            }, 2000);
          }
        }, 300);
      });
    }
    
    function eliminarReporte(id) {
      const reporte = reportes[id];
      if (!reporte) return;
      
      const seccion = reporte.seccion;
      
      // Eliminar el reporte
      delete reportes[id];
      
      // Actualizar la vista
      cargarReportes(seccion);
      
      // Guardar en GitHub
      guardarDatosEnGitHub().then(exito => {
        // Mostrar notificación
        mostrarNotificacion(exito ? 
          "Reporte eliminado correctamente" : 
          "Reporte eliminado localmente (error de conexión con GitHub)"
        );
      });
    }
    
    function guardarNuevoReporte() {
      const seccion = document.getElementById("nuevo-reporte-seccion").value;
      const titulo = document.getElementById("nuevo-reporte-titulo").value;
      const descripcion = document.getElementById("nuevo-reporte-descripcion").value;
      const fecha = document.getElementById("nuevo-reporte-fecha").value;
      const url = document.getElementById("nuevo-reporte-url").value;
      const textoBoton = document.getElementById("nuevo-reporte-boton").value;
      
      if (!titulo || !descripcion) {
        mostrarNotificacion("Por favor completa los campos requeridos", "error");
        return;
      }
      
      // Generar ID único
      const id = "reporte-" + Date.now();
      
      // Crear nuevo reporte
      reportes[id] = {
        id,
        seccion,
        titulo,
        descripcion,
        fecha,
        url,
        textoBoton
      };
      
      // Actualizar la vista
      cargarReportes(seccion);
      
      // Guardar en GitHub
      guardarDatosEnGitHub().then(exito => {
        // Cerrar modal y mostrar notificación
        cerrarModal("modal-nuevo-reporte");
        mostrarNotificacion(exito ? 
          "Reporte creado correctamente" : 
          "Reporte guardado localmente (error de conexión con GitHub)"
        );
        
        // Resaltar el nuevo reporte
        setTimeout(() => {
          const reporteElement = document.querySelector(`[data-id="${id}"]`);
          if (reporteElement) {
            reporteElement.classList.add("update-highlight");
            setTimeout(() => {
              reporteElement.classList.remove("update-highlight");
            }, 2000);
          }
        }, 300);
      });
    }
    
    function toggleEditMode(seccion) {
      editMode[seccion] = !editMode[seccion];
      
      const btn = document.getElementById(`btn-edit-${seccion}`);
      const reportesElements = document.querySelectorAll(`#reportes-${seccion} .card`);
      
      if (editMode[seccion]) {
        btn.textContent = "Guardar cambios";
        btn.classList.remove("btn-secondary");
        btn.classList.add("bg-blue-500", "hover:bg-blue-600");
        
        reportesElements.forEach(reporte => {
          reporte.classList.add("edit-mode");
          const controls = reporte.querySelector(".editor-controls");
          if (controls) controls.classList.remove("hidden");
        });
      } else {
        btn.textContent = "Modo edición";
        btn.classList.add("btn-secondary");
        btn.classList.remove("bg-blue-500", "hover:bg-blue-600");
        
        reportesElements.forEach(reporte => {
          reporte.classList.remove("edit-mode");
          const controls = reporte.querySelector(".editor-controls");
          if (controls) controls.classList.add("hidden");
        });
        
        // Guardar cambios en GitHub
        guardarDatosEnGitHub().then(exito => {
          // Mostrar notificación
          mostrarNotificacion(exito ? 
            "Cambios guardados correctamente" : 
            "Cambios guardados localmente (error de conexión con GitHub)"
          );
        });
      }
    }
    
    // Añadir botón de configuración de GitHub en el header para administradores
    function agregarBotonConfiguracionGitHub() {
      if (usuarioActual && usuarioActual.rol === "admin") {
        const headerControls = document.querySelector("header .flex.items-center.space-x-4");
        
        if (headerControls) {
          // Crear botón de configuración
          const configBtn = document.createElement("button");
          configBtn.className = "px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium transition flex items-center";
          configBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            GitHub
          `;
          configBtn.onclick = configurarGitHub;
          
          // Insertar antes del botón de cerrar sesión
          headerControls.insertBefore(configBtn, headerControls.lastElementChild);
        }
      }
    }
    
    // Modificar la función mostrarContenido para añadir el botón de configuración
    function mostrarContenido() {
      document.getElementById("login-box").classList.add("hidden");
      document.getElementById("contenido").classList.remove("hidden");
      
      // Mostrar nombre de usuario y badge de rol
      document.getElementById("nombre-usuario").textContent = usuarioActual.nombre;
      
      const badgeContainer = document.getElementById("badge-container");
      let badgeClass = "";
      let badgeText = "";
      
      switch(usuarioActual.rol) {
        case "admin":
          badgeClass = "badge-admin";
          badgeText = "Administrador";
          break;
        case "comercial":
          badgeClass = "badge-comercial";
          badgeText = "Comercial";
          break;
      }
      
      badgeContainer.innerHTML = `<span class="badge ${badgeClass}">${badgeText}</span>`;
      
      // Mostrar/ocultar elementos según el rol
      const adminElements = document.querySelectorAll(".admin-only");
      
      adminElements.forEach(el => {
        if (usuarioActual.rol === "admin") {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      });
      
      // Añadir botón de configuración de GitHub para administradores
      agregarBotonConfiguracionGitHub();
      
      // Cargar reportes
      cargarReportes("estrategia");
      cargarReportes("institucional");
    }
    
    // Mantener el resto de funciones igual
    
    // Inicializar la aplicación cuando se carga la página
    document.addEventListener("DOMContentLoaded", inicializar);
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93f3f5ab26140ec6',t:'MTc0NzE1ODIyMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
